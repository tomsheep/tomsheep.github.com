---
layout: post
category : 儒林外史
title: 屌丝的自我修养（80）
date: 2012-08-10 00:19:23 +08:00
tagline:
tags: [Redis, 数据库, NoSQL, 磁盘, 缓存, 环保, 立秋]
---


1. 我找了个健身教练。

2. 立秋那天晚上我住的小区里到处都是鞭炮声，大伙还真讲究。但凡环保也能成为习俗，还要美帝使馆做甚？——古往今来 要成事，都得往悬乎了整，才能让人有敬畏心，连造反都是这样。科学解释的太清楚，反而没人畏惧，要是俗话说“乱扔垃圾死舅舅”、古人云“贴小广告张疥疮”这就好了。

3. 在贴笔记之前我一定要讲个笑话，这是原则。咦，好像第一条讲过了啊？

4. Redis是一个基于key/value的数据结构服务器(data structures server)，提供字符串、列表、set、sorted set、hash五种数据结构接口：

    * Redis 将数据存储于内存中,或被配置为使用虚拟内存。通过两种方式可以实现数据持久化 

        1. snapshot: 按XX时间内多少次写入为限，将内存中的数据不断写入磁盘。性能较高,但是可能会引起一定程度的数据丢失 

        2. AOF(Append Only File) 记录每次操作日志，性能较低。当不使用snapshot时，一定需要AOF写入RAID array中或者至少配置一个redis slave以供发生灾难时恢复。

    * 目前只有主从复制，还没有集群功能，计划在3.0版本加入。 

    * 关于持久化，一个写操作完整的过程是： 

        1. 客户端向服务端发送写操作（数据在客户端的内存中） 

        2. 数据库服务端接收到写请求的数据（数据在服务端的内存中） 

        3. 服务端调用write系统调用，将数据往磁盘上写（数据在系统内存的缓冲区中） 

        4. 操作系统将缓冲区中的数据转移到磁盘控制器上（数据在磁盘缓存中） 

        5. 磁盘控制器将数据写到磁盘的物理介质中（数据真正落到磁盘上） 

        发生数据库server错误时，只要保证步骤3完成就是安全的；但当断电时，只有步骤5完成才是安全的。见文章 [redis-persistence-demystified][1] 

    * Redis提供多种数据结构接口：相较于将对象的每个字段存成单个 string 类型, 将一个对象存储在 hash 类型中会占用更少的内存,并且可以更方便的存取整个对象。省内存的原因是新建一个 hash 对象时开始是用 zipmap来存储的。这个 zipmap 其实并不是 hash table,但是 zipmap 相比正常的 hash 实现可以节省不少 hash 本身需要的一些元数据存储开销。

    * redis 没有使用操作系统提供的虚拟内存机制，而是自己在实现了自己的虚拟内存机制。因为OS虚存交换单位最小是4k，redis需要更小粒度。另外redis 可以将被交换到磁盘的对象进行压缩。

    * 更多使用可以参考 [The Redis Cookbook][2] .

5. 关于磁盘缓存：在磁盘中嵌入的一块高速的内存，用来保存经常访问的数据从而提高读写效率。Linux 下用`hdparam -i <磁盘设备文件>`可看到详细内容。磁盘缓存和磁盘控制器缓存的作用都是缓存读、预读、回写（写缓存很多情况下会被关掉，以免出现数据丢失）。此外磁盘缓存有保存IO命令队列的功能，单个的磁盘一次只能处理一个IO命令，但却能接收多个IO命令，这些进入到磁盘而未被处理的命令就保存在缓存中的IO队列中。参见 [缓存和RAID如何提高磁盘IO性能][3] 和 [浅谈磁盘控制器驱动][4] 。


[1]: http://antirez.com/post/redis-persistence-demystified.html "redis-persistence-demystified"
[2]: http://book.douban.com/subject/6782272/ "The Redis Cookbook"
[3]: http://www.dbabeta.com/2009/io-performence-02_cache-and-raid.html "缓存和RAID如何提高磁盘IO性能"
[4]: http://www.360doc.com/content/12/0307/00/1309227_192357112.shtml "浅谈磁盘控制器驱动"
